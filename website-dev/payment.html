<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ - Kampai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Toss Payments SDK -->
    <script src="https://js.tosspayments.com/v1/payment"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%); }
        .gradient-text { background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="text-2xl font-bold gradient-text">ğŸº Kampai</a>
                <a href="index.html" class="text-gray-500 hover:text-gray-700 flex items-center gap-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    ëŒì•„ê°€ê¸°
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 py-12">
        <!-- ê²°ì œ ì§„í–‰ ìƒíƒœ -->
        <div class="flex items-center justify-center gap-4 mb-12">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm">âœ“</div>
                <span class="text-sm font-medium text-green-600">í”Œëœ ì„ íƒ</span>
            </div>
            <div class="w-16 h-0.5 bg-green-500"></div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm">âœ“</div>
                <span class="text-sm font-medium text-green-600">íšŒì›ê°€ì…</span>
            </div>
            <div class="w-16 h-0.5 bg-purple-500"></div>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full gradient-bg text-white flex items-center justify-center text-sm">3</div>
                <span class="text-sm font-medium gradient-text">ê²°ì œ</span>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- í”Œëœ ì •ë³´ -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h2 class="text-xl font-bold mb-6">ì„ íƒí•œ í”Œëœ</h2>
                
                <div id="planDetails" class="border-2 border-purple-200 rounded-xl p-6 bg-purple-50">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>

                <div class="mt-6 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">ì›”ê°„ êµ¬ë…ë£Œ</span>
                        <span id="monthlyPrice" class="font-medium">-</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-500">ë¶€ê°€ì„¸ (10%)</span>
                        <span id="taxAmount" class="font-medium">-</span>
                    </div>
                    <hr>
                    <div class="flex justify-between text-lg font-bold">
                        <span>ì´ ê²°ì œ ê¸ˆì•¡</span>
                        <span id="totalPrice" class="gradient-text">-</span>
                    </div>
                </div>

                <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-500">
                    <p>ğŸ’¡ <strong>ê²°ì œ ì•ˆë‚´</strong></p>
                    <ul class="mt-2 space-y-1 text-xs">
                        <li>â€¢ ì›”ê°„ ìë™ ê²°ì œë©ë‹ˆë‹¤</li>
                        <li>â€¢ ì–¸ì œë“  í•´ì§€ ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>â€¢ ê²°ì œ í›„ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤</li>
                        <li>â€¢ 7ì¼ ì´ë‚´ í™˜ë¶ˆ ë³´ì¥</li>
                    </ul>
                </div>
            </div>

            <!-- ê²°ì œ ë°©ë²• -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h2 class="text-xl font-bold mb-6">ê²°ì œ ë°©ë²•</h2>
                
                <!-- ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ -->
                <div class="space-y-3 mb-6">
                    <label class="flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-purple-300 transition payment-method active" data-method="card">
                        <input type="radio" name="paymentMethod" value="card" checked class="w-4 h-4 text-purple-600">
                        <i data-lucide="credit-card" class="w-5 h-5 text-gray-600"></i>
                        <span class="font-medium">ì‹ ìš©/ì²´í¬ì¹´ë“œ</span>
                    </label>
                    
                    <label class="flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-purple-300 transition payment-method" data-method="kakaopay">
                        <input type="radio" name="paymentMethod" value="kakaopay" class="w-4 h-4 text-purple-600">
                        <span class="text-xl">ğŸ’›</span>
                        <span class="font-medium">ì¹´ì¹´ì˜¤í˜ì´</span>
                    </label>
                    
                    <label class="flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-purple-300 transition payment-method" data-method="naverpay">
                        <input type="radio" name="paymentMethod" value="naverpay" class="w-4 h-4 text-purple-600">
                        <span class="text-xl">ğŸ’š</span>
                        <span class="font-medium">ë„¤ì´ë²„í˜ì´</span>
                    </label>
                    
                    <label class="flex items-center gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-purple-300 transition payment-method" data-method="transfer">
                        <input type="radio" name="paymentMethod" value="transfer" class="w-4 h-4 text-purple-600">
                        <i data-lucide="building" class="w-5 h-5 text-gray-600"></i>
                        <span class="font-medium">ê³„ì¢Œì´ì²´</span>
                    </label>
                </div>

                <!-- ì•½ê´€ ë™ì˜ -->
                <div class="space-y-2 mb-6 text-sm">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="agreeAll" class="w-4 h-4 text-purple-600 rounded">
                        <span class="font-medium">ì „ì²´ ë™ì˜</span>
                    </label>
                    <div class="pl-6 space-y-1 text-gray-500">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="agree-item w-3 h-3" required>
                            <span>(í•„ìˆ˜) ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="agree-item w-3 h-3" required>
                            <span>(í•„ìˆ˜) ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="agree-item w-3 h-3" required>
                            <span>(í•„ìˆ˜) ê²°ì œ ë° í™˜ë¶ˆ ì •ì±…</span>
                        </label>
                    </div>
                </div>

                <!-- ê²°ì œ ë²„íŠ¼ -->
                <button id="payButton" onclick="processPayment()" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ê²°ì œí•˜ê¸°
                </button>
                
                <p class="text-center text-xs text-gray-400 mt-4">
                    ğŸ”’ ê²°ì œ ì •ë³´ëŠ” ì•”í˜¸í™”ë˜ì–´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤
                </p>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:5000';
        
        // í”Œëœ ì •ë³´
        const PLANS = {
            basic: {
                name: 'Basic',
                price: 4900,
                features: ['í•˜ë£¨ 30ì¥ ìƒì„±', 'FLUX Schnell', '1024x1024', 'ì›Œí„°ë§ˆí¬ ì—†ìŒ', 'ìƒì—…ì  ì‚¬ìš© OK']
            },
            pro: {
                name: 'Pro',
                price: 19900,
                features: ['í•˜ë£¨ 100ì¥ ìƒì„±', 'ëª¨ë¸ ì„ íƒ ê°€ëŠ¥', 'Qwen-Image / FLUX 2 Pro / FLUX Ultra', 'ìµœëŒ€ 2048x2048', 'ìš°ì„  ì²˜ë¦¬']
            },
            business: {
                name: 'Business',
                price: 99000,
                features: ['í•˜ë£¨ 500ì¥ ìƒì„±', 'ëª¨ë“  í”„ë¦¬ë¯¸ì—„ ëª¨ë¸', 'íŒ€ì› 5ëª…', 'API ì•¡ì„¸ìŠ¤', 'ì „ë‹´ ì§€ì›']
            }
        };

        // URLì—ì„œ í”Œëœ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const selectedPlan = urlParams.get('plan');
        
        // ì¸ì¦ í™•ì¸
        const token = localStorage.getItem('kampai_token');
        const user = JSON.parse(localStorage.getItem('kampai_user') || 'null');
        
        if (!token || !user) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
            window.location.href = 'index.html';
        }
        
        if (!selectedPlan || !PLANS[selectedPlan]) {
            alert('ìœ íš¨í•˜ì§€ ì•Šì€ í”Œëœì…ë‹ˆë‹¤');
            window.location.href = 'index.html#pricing';
        }

        // í”Œëœ ì •ë³´ í‘œì‹œ
        function displayPlanInfo() {
            const plan = PLANS[selectedPlan];
            const tax = Math.round(plan.price * 0.1);
            const total = plan.price + tax;
            
            document.getElementById('planDetails').innerHTML = `
                <div class="text-center">
                    <h3 class="text-2xl font-bold gradient-text">${plan.name}</h3>
                    <div class="text-3xl font-bold mt-2">${plan.price.toLocaleString()}<span class="text-lg text-gray-500">ì›/ì›”</span></div>
                </div>
                <ul class="mt-4 space-y-2">
                    ${plan.features.map(f => `
                        <li class="flex items-center gap-2 text-sm">
                            <i data-lucide="check" class="w-4 h-4 text-green-500"></i>
                            ${f}
                        </li>
                    `).join('')}
                </ul>
            `;
            
            document.getElementById('monthlyPrice').textContent = `${plan.price.toLocaleString()}ì›`;
            document.getElementById('taxAmount').textContent = `${tax.toLocaleString()}ì›`;
            document.getElementById('totalPrice').textContent = `${total.toLocaleString()}ì›`;
            
            // Lucide ì•„ì´ì½˜ ì¬ì´ˆê¸°í™”
            lucide.createIcons();
        }

        // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ UI
        document.querySelectorAll('.payment-method').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.payment-method').forEach(m => {
                    m.classList.remove('active', 'border-purple-500');
                    m.classList.add('border-gray-200');
                });
                el.classList.add('active', 'border-purple-500');
                el.classList.remove('border-gray-200');
            });
        });

        // ì „ì²´ ë™ì˜
        document.getElementById('agreeAll').addEventListener('change', function() {
            document.querySelectorAll('.agree-item').forEach(cb => {
                cb.checked = this.checked;
            });
            updatePayButton();
        });

        // ê°œë³„ ë™ì˜
        document.querySelectorAll('.agree-item').forEach(cb => {
            cb.addEventListener('change', updatePayButton);
        });

        function updatePayButton() {
            const allChecked = Array.from(document.querySelectorAll('.agree-item')).every(cb => cb.checked);
            document.getElementById('payButton').disabled = !allChecked;
            
            // ì „ì²´ ë™ì˜ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('agreeAll').checked = allChecked;
        }

        // ê²°ì œ ì²˜ë¦¬
        async function processPayment() {
            const btn = document.getElementById('payButton');
            const plan = PLANS[selectedPlan];
            const tax = Math.round(plan.price * 0.1);
            const total = plan.price + tax;
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            
            btn.disabled = true;
            btn.textContent = 'ê²°ì œ ì²˜ë¦¬ ì¤‘...';

            try {
                // 1. ì„œë²„ì—ì„œ ì£¼ë¬¸ ìƒì„±
                const orderResponse = await fetch(`${API_URL}/api/payment/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        plan: selectedPlan,
                        amount: total,
                        paymentMethod: paymentMethod
                    })
                });

                const orderData = await orderResponse.json();

                if (!orderData.success) {
                    throw new Error(orderData.error || 'ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨');
                }

                // 2. í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë°”ë¡œ ì„±ê³µ ì²˜ë¦¬ (ì‹¤ì œ ìš´ì˜ì‹œ í† ìŠ¤í˜ì´ë¨¼ì¸  ì—°ë™)
                if (orderData.testMode) {
                    // í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ë°”ë¡œ ê²°ì œ ì„±ê³µ ì²˜ë¦¬
                    const confirmResponse = await fetch(`${API_URL}/api/payment/confirm`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            orderId: orderData.orderId,
                            paymentKey: 'test_payment_' + Date.now(),
                            amount: total
                        })
                    });

                    const confirmData = await confirmResponse.json();

                    if (confirmData.success) {
                        // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                        localStorage.setItem('kampai_user', JSON.stringify({
                            ...user,
                            plan: selectedPlan
                        }));
                        localStorage.removeItem('kampai_selected_plan');
                        
                        alert(`ğŸ‰ ${plan.name} í”Œëœ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\nì§€ê¸ˆ ë°”ë¡œ ì´ìš©í•˜ì„¸ìš”.`);
                        window.location.href = 'generate.html';
                    } else {
                        throw new Error(confirmData.error || 'ê²°ì œ í™•ì¸ ì‹¤íŒ¨');
                    }
                } else {
                    // ì‹¤ì œ í† ìŠ¤í˜ì´ë¨¼ì¸  ê²°ì œ (ì¶”í›„ êµ¬í˜„)
                    const tossPayments = TossPayments(orderData.clientKey);
                    
                    await tossPayments.requestPayment(paymentMethod === 'card' ? 'ì¹´ë“œ' : paymentMethod, {
                        amount: total,
                        orderId: orderData.orderId,
                        orderName: `Kampai ${plan.name} í”Œëœ (ì›”ê°„)`,
                        customerName: user.name || user.email,
                        successUrl: `${window.location.origin}/payment-success.html`,
                        failUrl: `${window.location.origin}/payment-fail.html`
                    });
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'ê²°ì œí•˜ê¸°';
                updatePayButton();
            }
        }

        // ì´ˆê¸°í™”
        displayPlanInfo();
        lucide.createIcons();
    </script>
</body>
</html>
